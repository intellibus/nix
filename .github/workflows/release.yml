name: ðŸ“¦ Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  create-release:
    name: ðŸŽ‰ Create Release
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â„ï¸ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: ðŸ§ª Final validation
        run: |
          echo "ðŸ” Checking flake..."
          nix flake check

          echo "ðŸ—ï¸ Building configurations..."
          nix build .#nixosConfigurations.nixos.config.system.build.toplevel --no-link

          echo "ðŸ  Building home-manager..."
          nix build .#homeConfigurations."jager@nixos".activationPackage --no-link

      - name: ðŸ“‹ Generate changelog
        run: |
          echo "# ðŸŽ‰ NixOS Configuration Release $(git describe --tags --abbrev=0)" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ“¦ What's Included" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ–¥ï¸ System Configuration" >> CHANGELOG.md
          echo "- NixOS system configuration with modular design" >> CHANGELOG.md
          echo "- Desktop environment support (GNOME/KDE/XFCE)" >> CHANGELOG.md
          echo "- Optional services (Docker, printing, Bluetooth, etc.)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ  Home Manager" >> CHANGELOG.md
          echo "- User environment configuration" >> CHANGELOG.md
          echo "- Development tools and editors" >> CHANGELOG.md
          echo "- Shell configuration with Zsh and Starship" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ”§ Tools" >> CHANGELOG.md
          echo "- Interactive setup script" >> CHANGELOG.md
          echo "- Makefile for common operations" >> CHANGELOG.md
          echo "- Comprehensive documentation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸš€ Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "# Download and extract" >> CHANGELOG.md
          echo "wget https://github.com/YOUR_USERNAME/YOUR_REPO/archive/$(git describe --tags --abbrev=0).tar.gz" >> CHANGELOG.md
          echo "tar -xzf $(git describe --tags --abbrev=0).tar.gz" >> CHANGELOG.md
          echo "cd YOUR_REPO-$(git describe --tags --abbrev=0)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# Run setup" >> CHANGELOG.md
          echo "./setup.sh" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## ðŸ“ Recent Changes" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --oneline --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD~1)..HEAD >> CHANGELOG.md

      - name: ðŸ“¦ Create tarball
        run: |
          tar -czf nixos-config-$(git describe --tags --abbrev=0).tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.tar.gz' \
            .

      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          files: |
            nixos-config-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¢ Post-release notification
        run: |
          echo "ðŸŽ‰ Release created successfully!"
          echo "ðŸ“¦ Tarball: nixos-config-$(git describe --tags --abbrev=0).tar.gz"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/$(git describe --tags --abbrev=0)"
