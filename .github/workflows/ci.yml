name: ğŸ” NixOS Configuration CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  check-flake:
    name: ğŸ§ª Check Flake
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: ğŸ” Check flake
        run: nix flake check

      - name: ğŸ“Š Show flake info
        run: nix flake show

  build-configurations:
    name: ğŸ—ï¸ Build Configurations
    runs-on: ubuntu-latest
    needs: check-flake
    strategy:
      matrix:
        configuration: [nixos]
      fail-fast: false

    steps:
      - name: ğŸ§¹ Free up disk space
        run: |
          echo "Available disk space before cleanup:"
          df -h

          # Remove unnecessary packages and clean package cache
          sudo apt-get clean
          sudo apt-get autoremove -y

          # Remove large unnecessary directories
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          # Clear Docker if present
          docker system prune -af || true

          echo "Available disk space after cleanup:"
          df -h

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Optimize for limited disk space
            min-free = 1073741824  # 1GB minimum free space
            max-free = 2147483648  # 2GB maximum free space

      - name: ğŸ—ï¸ Build NixOS configuration
        env:
          NIXOS_CI_BUILD: "true" # Skip heavy packages during CI builds
        run: |
          echo "Disk space before build:"
          df -h

          # Build with optimizations for limited space
          nix build .#nixosConfigurations.${{ matrix.configuration }}.config.system.build.toplevel \
            --no-link --print-build-logs \
            --option max-jobs 1 \
            --option cores 2
            
          echo "Disk space after build:"
          df -h

          # Clean up after build to free space
          nix-collect-garbage

          echo "Disk space after cleanup:"
          df -h

  check-home-manager:
    name: ğŸ  Check Home Manager
    runs-on: ubuntu-latest
    needs: check-flake

    steps:
      - name: ğŸ§¹ Free up disk space
        run: |
          echo "Available disk space before cleanup:"
          df -h

          # Remove unnecessary packages and clean package cache
          sudo apt-get clean
          sudo apt-get autoremove -y

          # Remove large unnecessary directories
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          # Clear Docker if present
          docker system prune -af || true

          echo "Available disk space after cleanup:"
          df -h

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Optimize for limited disk space
            min-free = 1073741824  # 1GB minimum free space
            max-free = 2147483648  # 2GB maximum free space

      - name: ğŸ  Build Home Manager configuration
        env:
          NIXOS_CI_BUILD: "true" # Skip heavy packages during CI builds
        run: |
          echo "Disk space before build:"
          df -h

          # Build with optimizations for limited space
          nix build .#homeConfigurations."jager@nixos".activationPackage \
            --no-link --print-build-logs \
            --option max-jobs 1 \
            --option cores 2
            
          echo "Disk space after build:"
          df -h

          # Clean up after build to free space
          nix-collect-garbage

          echo "Disk space after cleanup:"
          df -h

  format-check:
    name: ğŸ“ Format Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â„ï¸ Install Nix
        uses: cachix/install-nix-action@v26
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: ğŸ“ Check Nix formatting
        run: |
          nix run nixpkgs#nixpkgs-fmt -- --check .

      - name: ğŸ’¾ Check for uncommitted formatting changes
        run: |
          if ! git diff --exit-code; then
            echo "âŒ Files are not formatted properly"
            echo "Run 'nix run nixpkgs#nixpkgs-fmt .' to fix formatting"
            exit 1
          else
            echo "âœ… All files are properly formatted"
          fi

  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for proper diff

      - name: ğŸ” Check for secrets (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --only-verified

      - name: ğŸ” Check for secrets (Push)
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --debug --only-verified

      - name: ğŸ” Full repository scan (Initial push or manual trigger)
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.event.before == '0000000000000000000000000000000000000000')
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

      - name: ğŸ”’ Check for hardcoded passwords
        run: |
          if grep -r "password.*=" . --include="*.nix" | grep -v "initialPassword\|hashedPassword"; then
            echo "âŒ Found potential hardcoded passwords"
            exit 1
          else
            echo "âœ… No hardcoded passwords found"
          fi
